rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ========= FUNÇÕES ========= */

    function isAuth() {
      return request.auth != null;
    }

    function myUid() {
      return request.auth.uid;
    }

    function myEmail() {
      return request.auth.token.email;
    }

    // ✅ Correção: lowercase() NÃO existe em Rules; o correto é lower()
    function myEmailLower() {
      return myEmail() != null ? myEmail().lower() : null;
    }

    function hasProfile() {
      return isAuth() && exists(/databases/$(database)/documents/profiles/$(myUid()));
    }

    function p() {
      return get(/databases/$(database)/documents/profiles/$(myUid())).data;
    }

    function isActive() {
      return hasProfile() && p().isActive == true;
    }

    function isDEV() {
      return hasProfile() && p().role == "DEV";
    }

    function isADMIN() {
      return hasProfile() && p().role == "ADMIN";
    }

    function isPrivileged() {
      return isDEV() || isADMIN();
    }

    // ✅ aceitar modules OU permissions (mantido)
    function hasModule(m) {
      return hasProfile() && (
        (p().modules[m] == true) ||
        (p().permissions[m] == true)
      );
    }

    function hasFinanceAccess() {
      return hasModule("finance") || hasModule("sales");
    }

    // Para leituras: menos restritivo (DEV/ADMIN passam, e usuário com módulo passa)
    function canReadModule(m) {
      return isAuth() && (isPrivileged() || hasModule(m));
    }

    // Para escritas: mantém controle (usuário comum precisa estar ativo)
    function canWriteModule(m) {
      return isAuth() && (isPrivileged() || (isActive() && hasModule(m)));
    }

    function isOwnerByField(field) {
      return resource.data[field] == myUid();
    }

    function isOwnerByFieldNew(field) {
      return request.resource.data[field] == myUid();
    }

    /* ========= USERS ========= */
    match /users/{uid} {
      // leitura mais aberta para admin/dev
      allow read: if isAuth() && (uid == myUid() || isPrivileged());
      allow create: if isAuth() && (uid == myUid() || isPrivileged());
      allow update: if isAuth() && (uid == myUid() || isPrivileged());
      allow delete: if false;
    }

    /* ========= INVITES ========= */
    match /invites/{id} {

      // Ler:
      // - DEV/ADMIN lê tudo
      // - usuário lê o próprio convite por docId email/emailLower ou por campo email
      allow read: if isAuth() && (
        isPrivileged() ||
        (myEmailLower() != null && myEmailLower() == id) ||
        (myEmail() != null && myEmail() == id) ||
        (myEmail() != null && myEmail() == resource.data.email)
      );

      // Criar convite: DEV/ADMIN
      allow create: if isAuth() && isPrivileged();

      // Atualizar convite:
      // - DEV/ADMIN pode
      // - o próprio usuário pode marcar como usado (usedBy) após criar conta
      allow update: if isAuth() && (
        isPrivileged() ||
        (
          myEmail() != null &&
          myEmail() == resource.data.email &&
          resource.data.usedAt == null &&
          request.resource.data.usedBy == myUid()
        )
      );

      allow delete: if false;
    }

    /* ========= PROFILES ========= */
    match /profiles/{uid} {

      // Ler:
      // - o próprio documento
      // - DEV/ADMIN lê tudo
      allow read: if isAuth() && (
        uid == myUid() ||
        isPrivileged()
      );

      // Criar:
      // - DEV/ADMIN pode
      // - usuário cria o próprio doc se tiver invite válido
      allow create: if isAuth() && (
        isPrivileged() ||
        (
          uid == myUid() &&
          myEmail() != null &&
          (
            (
              exists(/databases/$(database)/documents/invites/$(myEmail())) &&
              get(/databases/$(database)/documents/invites/$(myEmail())).data.usedAt == null
            ) ||
            (
              myEmailLower() != null &&
              exists(/databases/$(database)/documents/invites/$(myEmailLower())) &&
              get(/databases/$(database)/documents/invites/$(myEmailLower())).data.usedAt == null
            )
          ) &&
          request.resource.data.email == myEmail()
        )
      );

      // Update:
      // - DEV/ADMIN pode atualizar tudo
      // - Usuário comum: só altera campos “seguros” e mantém sensíveis iguais
      allow update: if isAuth() && (
        isPrivileged() ||
        (
          uid == myUid() &&

          // Bloqueia alterações sensíveis
          request.resource.data.role == resource.data.role &&
          request.resource.data.modules == resource.data.modules &&
          request.resource.data.permissions == resource.data.permissions &&
          request.resource.data.email == resource.data.email &&
          request.resource.data.emailLower == resource.data.emailLower &&

          // Usuário comum pode manter status/ativação sob controle
          (
            request.resource.data.isActive == resource.data.isActive ||
            (
              resource.data.isActive == false &&
              request.resource.data.isActive == true &&
              resource.data.userStatus == "PENDING" &&
              request.resource.data.userStatus == "ACTIVE"
            )
          )
        )
      );

      allow delete: if false;
    }

    /* ========= SYSTEM / CONFIG ========= */
    match /system/{id} {
      allow read: if isAuth();
      allow write: if isAuth() && isDEV();
    }

    match /config/{id} {
      allow read: if isAuth();
      allow write: if isAuth() && isDEV();
    }

    /* ========= WEBHOOKS ========= */
    match /webhooks/{id} {
      allow read: if isAuth() && isPrivileged();
      allow write: if isAuth() && isPrivileged();
    }

    /* ========= VENDAS360 / FINANCE ========= */

    match /accounts/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId")) ||
        (isActive() && hasFinanceAccess() && isADMIN())
      );

      allow create: if canWriteModule("finance") && (
        isPrivileged() || isOwnerByFieldNew("userId")
      );

      allow update: if canWriteModule("finance") && (
        isPrivileged() || isOwnerByField("userId")
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /transactions/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /sales/{id} {
      // ✅ leitura menos restritiva: dev/admin sempre, e sales ativo+modulo pelo owner
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /sales_tasks/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /clients/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /receivables/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /campaigns/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasModule("sales") && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /cards/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /categories/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /goals/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /challenges/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /challenge_cells/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && hasFinanceAccess() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isPrivileged();
    }

    match /tickets/{id} {
      // tickets: leitura mais ampla para evitar “tela vazia”
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && (isOwnerByField("userId")))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && isOwnerByFieldNew("userId"))
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && isOwnerByField("userId"))
      );

      allow delete: if isAuth() && isActive() && isDEV();
    }

    /* ========= TABELAS DE COMISSÃO ========= */
    match /commission_basic/{docId} {
      allow read: if isAuth() && isPrivileged();
      allow write: if isAuth() && isPrivileged();
    }

    match /commission_natal/{docId} {
      allow read: if isAuth() && isPrivileged();
      allow write: if isAuth() && isPrivileged();
    }

    match /commissions_basic/{docId} {
      allow read: if isAuth();
      allow write: if isAuth() && isPrivileged();
    }

    match /commissions_natal/{docId} {
      allow read: if isAuth();
      allow write: if isAuth() && isPrivileged();
    }

    /* ========= AUDIT ========= */
    match /audit_log/{id} {
      allow read: if isAuth() && (isPrivileged() || hasModule("logs"));
      allow create: if isAuth();
      allow update, delete: if false;
    }

    /* ========= INTERNAL MESSAGES ========= */
    match /internal_messages/{id} {
      allow read: if isAuth() && (
        isPrivileged() ||
        (isActive() && (
          resource.data.senderId == myUid() ||
          resource.data.recipientId == myUid() ||
          resource.data.recipientId == "BROADCAST"
        ))
      );

      allow create: if isAuth() && (
        isPrivileged() ||
        (isActive() && request.resource.data.senderId == myUid())
      );

      allow update: if isAuth() && (
        isPrivileged() ||
        (isActive() && (
          resource.data.senderId == myUid() ||
          resource.data.recipientId == myUid()
        ))
      );

      allow delete: if false;
    }
  }
}
